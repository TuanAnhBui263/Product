<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô Hình Dây Chuyền Sản Xuất Bánh Mì</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8fafc;
            padding: 1rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
        }

        .button-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-start {
            background-color: #10b981;
            color: white;
        }

        .btn-start:hover {
            background-color: #059669;
        }

        .btn-pause {
            background-color: #f59e0b;
            color: white;
        }

        .btn-pause:hover {
            background-color: #d97706;
        }

        .btn-reset {
            background-color: #6b7280;
            color: white;
        }

        .btn-reset:hover {
            background-color: #4b5563;
        }

        .btn-config {
            background-color: #3b82f6;
            color: white;
        }

        .btn-config:hover {
            background-color: #2563eb;
        }

        .btn-speed {
            background-color: #8b5cf6;
            color: white;
        }

        .btn-speed:hover {
            background-color: #7c3aed;
        }

        .time-display {
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
        }

        .speed-display {
            font-weight: 500;
            color: #7c3aed;
            white-space: nowrap;
        }

        .eta-display {
            font-weight: 500;
            color: #059669;
            white-space: nowrap;
        }

        .config-panel {
            display: none;
            margin-top: 1rem;
        }

        .config-panel.show {
            display: block;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .config-item label {
            font-weight: 500;
            color: #374151;
        }

        .config-item input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .config-item input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 1rem;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .text-blue-600 { color: #2563eb; }
        .text-yellow-600 { color: #d97706; }
        .text-green-600 { color: #059669; }
        .text-purple-600 { color: #7c3aed; }
        .text-red-600 { color: #dc2626; }

        .production-flow {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .worker-station {
            background: #f9fafb;
            border: 2px solid;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            min-width: 200px;
        }

        .border-blue-500 { border-color: #3b82f6; }
        .border-yellow-500 { border-color: #eab308; }
        .border-green-500 { border-color: #22c55e; }
        .border-purple-500 { border-color: #8b5cf6; }

        .queue-display {
            background: #f3f4f6;
            border: 2px dashed;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            min-width: 120px;
        }

        .border-blue-300 { border-color: #93c5fd; }
        .border-green-300 { border-color: #86efac; }

        .queue-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #374151;
            margin-top: 0.5rem;
        }

        .flow-arrow {
            font-size: 1.5rem;
            color: #6b7280;
            font-weight: bold;
        }

        .worker-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .worker-status {
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }

        .worker-free {
            background-color: #d1fae5;
            color: #065f46;
        }

        .worker-busy {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .parallel-lines {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .line-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }

        .line-title {
            font-weight: 600;
            color: #1e293b;
            text-align: center;
            margin-bottom: 1rem;
        }

        .line-station {
            background: white;
            border: 2px solid;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .station-name {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .station-status {
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table tbody tr:hover {
            background-color: #f9fafb;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .button-group {
                justify-content: center;
            }

            .production-flow {
                flex-direction: column;
                text-align: center;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }

            .parallel-lines {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <div class="header">
                <h1>Mô Hình Dây Chuyền Sản Xuất Bánh Mì</h1>
                
                <div class="button-group">
                    <button id="playPauseBtn" class="btn btn-start">
                        <span id="playPauseIcon">▶</span>
                        <span id="playPauseText">Bắt đầu</span>
                    </button>
                    
                    <button id="speedBtn" class="btn btn-speed">
                        <span>⚡</span>
                        <span id="speedText">1x</span>
                    </button>
                    
                    <button id="resetBtn" class="btn btn-reset">
                        <span>↻</span>
                        Reset
                    </button>
                    
                    <button id="configBtn" class="btn btn-config">
                        <span>⚙</span>
                        Cấu hình
                    </button>
                    
                    <div class="time-display">
                        Thời gian: <span id="currentTime">00:00:00</span>
                    </div>
                    
                    <div class="speed-display">
                        Tốc độ: <span id="currentSpeed">1x</span>
                    </div>
                    
                    <div class="eta-display">
                        Dự kiến hoàn thành: <span id="etaTime">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div id="configPanel" class="card config-panel">
            <h2 style="margin-bottom: 1rem; font-size: 1.25rem; font-weight: bold;">Cấu hình dây chuyền</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label>Tổng số bánh mì</label>
                    <input type="number" id="totalBreads" value="4500">
                </div>
                <div class="config-item">
                    <label>Thời gian cắt bánh (s)</label>
                    <input type="number" id="cutTime" value="5">
                </div>
                <div class="config-item">
                    <label>Thời gian quét bơ (s)</label>
                    <input type="number" id="butterTime" value="15">
                </div>
                <div class="config-item">
                    <label>Thời gian bỏ rau (s)</label>
                    <input type="number" id="vegetableTime" value="20">
                </div>
                <div class="config-item">
                    <label>Thời gian đóng gói (s)</label>
                    <input type="number" id="packTime" value="5">
                </div>
                <div class="config-item">
                    <label>Số người cắt bánh</label>
                    <input type="number" id="cutWorkers" min="1" value="2" onchange="updateConfig()">
                </div>
                <div class="config-item">
                    <label>Số người quét bơ</label>
                    <input type="number" id="butterWorkers" min="1" value="4" onchange="updateConfig()">
                </div>
                <div class="config-item">
                    <label>Số người bỏ rau</label>
                    <input type="number" id="vegetableWorkers" min="1" value="4" onchange="updateConfig()">
                </div>
                <div class="config-item">
                    <label>Số người đóng gói</label>
                    <input type="number" id="packWorkers" min="1" value="2" onchange="updateConfig()">
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="card">
            <h2 style="margin-bottom: 1rem; font-size: 1.25rem; font-weight: bold;">Tiến độ tổng thể</h2>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">
                    <span>Hoàn thành: <span id="completedCount">0</span>/<span id="totalCount">4500</span></span>
                    <span id="completionPercentage">0.0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number text-blue-600" id="cutCompleted">0</div>
                    <div class="stat-label">Đã cắt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-yellow-600" id="butterCompleted">0</div>
                    <div class="stat-label">Đã quét bơ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-green-600" id="vegetableCompleted">0</div>
                    <div class="stat-label">Đã bỏ rau</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-purple-600" id="packCompleted">0</div>
                    <div class="stat-label">Đã đóng gói</div>
                </div>
            </div>
        </div>

        <!-- Production Line Diagram -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: bold;">Sơ đồ dây chuyền sản xuất</h2>
            
            <!-- Cutting Station -->
            <div class="production-flow">
                <div class="worker-station border-blue-500">
                    <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">Cắt bánh </h3>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Thời gian: <span id="cutTimeDisplay">5</span>s</div>
                    <div class="worker-grid" id="cutterWorkers">
                        <!-- Workers will be populated by JavaScript -->
                    </div>
                </div>
                <div class="flow-arrow">→</div>
                <div class="queue-display border-blue-300">
                    <h4 style="font-weight: 500; color: #1f2937;">Hàng đợi quét bơ</h4>
                    <div class="queue-count" id="afterCutQueue">0</div>
                </div>
            </div>

            <!-- Parallel Processing Indicator -->
            <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <div class="flow-arrow">↓</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Phân chia cho 4 dây chuyền song song</div>
            </div>

            <!-- Parallel Lines -->
            <div class="parallel-lines" id="parallelLines">
                <!-- Lines will be populated by JavaScript -->
            </div>

            <!-- Convergence -->
            <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <div class="flow-arrow">↓</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Tập hợp từ 4 dây chuyền</div>
            </div>

            <!-- Packing Station -->
            <div class="production-flow" style="justify-content: center;">
                <div class="queue-display border-green-300">
                    <h4 style="font-weight: 500; color: #1f2937;">Hàng đợi đóng gói</h4>
                    <div class="queue-count" id="afterVegetableQueue">0</div>
                </div>
                <div class="flow-arrow">→</div>
                <div class="worker-station border-purple-500">
                    <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">Đóng gói </h3>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Thời gian: <span id="packTimeDisplay">5</span>s</div>
                    <div class="worker-grid" id="packerWorkers">
                        <!-- Workers will be populated by JavaScript -->
                    </div>
                </div>
                <div class="flow-arrow">→</div>
                <div class="worker-station border-green-500">
                    <h3 style="font-weight: 600; color: #1f2937;">Hoàn thành</h3>
                    <div style="font-size: 1.875rem; font-weight: bold; color: #059669;" id="finalCompleted">0</div>
                </div>
            </div>
        </div>

        <!-- Statistics Table -->
        <div class="card">
            <h2 style="margin-bottom: 1rem; font-size: 1.25rem; font-weight: bold;">Thống kê chi tiết</h2>
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Công đoạn</th>
                            <th>Số người</th>
                            <th>Thời gian (s)</th>
                            <th>Đã hoàn thành</th>
                            <th>Đang làm</th>
                            <th>Hiệu suất</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cắt bánh</td>
                            <td id="cutWorkersCount">2</td>
                            <td id="cutTimeTable">5</td>
                            <td id="cutCompletedTable">0</td>
                            <td class="text-red-600" id="cutInProgressTable">0</td>
                            <td id="cutEfficiencyTable">0 bánh/phút</td>
                        </tr>
                        <tr>
                            <td>Quét bơ</td>
                            <td id="butterWorkersCount">4</td>
                            <td id="butterTimeTable">15</td>
                            <td id="butterCompletedTable">0</td>
                            <td class="text-red-600" id="butterInProgressTable">0</td>
                            <td id="butterEfficiencyTable">0 bánh/phút</td>
                        </tr>
                        <tr>
                            <td>Bỏ rau</td>
                            <td id="vegetableWorkersCount">4</td>
                            <td id="vegetableTimeTable">20</td>
                            <td id="vegetableCompletedTable">0</td>
                            <td class="text-red-600" id="vegetableInProgressTable">0</td>
                            <td id="vegetableEfficiencyTable">0 bánh/phút</td>
                        </tr>
                        <tr>
                            <td>Đóng gói</td>
                            <td id="packWorkersCount">2</td>
                            <td id="packTimeTable">5</td>
                            <td id="packCompletedTable">0</td>
                            <td class="text-red-600" id="packInProgressTable">0</td>
                            <td id="packEfficiencyTable">0 bánh/phút</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
// Global state
let config = {
    totalBreads: 4500,
    cutTime: 5,
    butterTime: 15,
    vegetableTime: 20,
    packTime: 5,
    cutWorkers: 2,
    butterWorkers: 4,
    vegetableWorkers: 4,
    packWorkers: 2
};

let isRunning = false;
let showConfig = false;
let currentTime = 0;
let intervalId = null;

// Tốc độ simulation
let speedOptions = [1, 2, 5, 10, 20, 50, 100, 200];
let currentSpeedIndex = 0;
let speedMultiplier = speedOptions[currentSpeedIndex];

let stats = {
    completed: 0,
    cutting: { completed: 0, inProgress: 0 },
    buttering: { completed: 0, inProgress: 0 },
    vegetables: { completed: 0, inProgress: 0 },
    packing: { completed: 0, inProgress: 0 }
};

let queues = {
    afterCut: [],
    afterButter: [],
    afterVegetables: []
};

let workers = {
    cutters: Array.from({ length: config.cutWorkers }, () => ({ busy: false, timeLeft: 0 })),
    butterWorkers: Array.from({ length: config.butterWorkers }, () => ({ busy: false, timeLeft: 0 })),
    vegetableWorkers: Array.from({ length: config.vegetableWorkers }, () => ({ busy: false, timeLeft: 0 })),
    packers: Array.from({ length: config.packWorkers }, () => ({ busy: false, timeLeft: 0 }))
};

// Timing variables
let lastUpdateTime = 0;
let accumulatedTime = 0;

// DOM elements
const playPauseBtn = document.getElementById('playPauseBtn');
const playPauseIcon = document.getElementById('playPauseIcon');
const playPauseText = document.getElementById('playPauseText');
const resetBtn = document.getElementById('resetBtn');
const configBtn = document.getElementById('configBtn');
const configPanel = document.getElementById('configPanel');
const speedBtn = document.getElementById('speedBtn');
const speedText = document.getElementById('speedText');

// Initialize the application
function init() {
    setupEventListeners();
    updateConfigInputs();
    initializeWorkerDisplays();
    updateUI();
}

function setupEventListeners() {
    playPauseBtn.addEventListener('click', toggleSimulation);
    resetBtn.addEventListener('click', resetSimulation);
    configBtn.addEventListener('click', toggleConfig);
    speedBtn.addEventListener('click', changeSpeed);

    // Config inputs
    document.getElementById('totalBreads').addEventListener('change', updateConfig);
    document.getElementById('cutTime').addEventListener('change', updateConfig);
    document.getElementById('butterTime').addEventListener('change', updateConfig);
    document.getElementById('vegetableTime').addEventListener('change', updateConfig);
    document.getElementById('packTime').addEventListener('change', updateConfig);
    document.getElementById('cutWorkers').addEventListener('change', updateConfig);
    document.getElementById('butterWorkers').addEventListener('change', updateConfig);
    document.getElementById('vegetableWorkers').addEventListener('change', updateConfig);
    document.getElementById('packWorkers').addEventListener('change', updateConfig);
}

function changeSpeed() {
    currentSpeedIndex = (currentSpeedIndex + 1) % speedOptions.length;
    speedMultiplier = speedOptions[currentSpeedIndex];
    
    // Update display
    speedText.textContent = speedMultiplier + 'x';
    document.getElementById('currentSpeed').textContent = speedMultiplier + 'x';
    
    // Restart simulation with new speed if running
    if (isRunning) {
        const savedAccumulatedTime = accumulatedTime;
        stopSimulation();
        accumulatedTime = savedAccumulatedTime;
        startSimulation();
    }
}

function updateConfig() {
    config.totalBreads = parseInt(document.getElementById('totalBreads').value) || 0;
    config.cutTime = parseInt(document.getElementById('cutTime').value) || 0;
    config.butterTime = parseInt(document.getElementById('butterTime').value) || 0;
    config.vegetableTime = parseInt(document.getElementById('vegetableTime').value) || 0;
    config.packTime = parseInt(document.getElementById('packTime').value) || 0;

    const newCutWorkers = parseInt(document.getElementById('cutWorkers').value) || 1;
    const newButterWorkers = parseInt(document.getElementById('butterWorkers').value) || 1;
    const newVegetableWorkers = parseInt(document.getElementById('vegetableWorkers').value) || 1;
    const newPackWorkers = parseInt(document.getElementById('packWorkers').value) || 1;

    updateWorkerCount('cut', newCutWorkers);
    updateWorkerCount('butter', newButterWorkers);
    updateWorkerCount('vegetable', newVegetableWorkers);
    updateWorkerCount('pack', newPackWorkers);
    
    resetSimulation();
}

function updateWorkerCount(type, count) {
    count = Math.max(1, parseInt(count) || 1);
    
    switch(type) {
        case 'cut':
            config.cutWorkers = count;
            workers.cutters = Array.from({ length: count }, () => ({ busy: false, timeLeft: 0 }));
            break;
        case 'butter':
            config.butterWorkers = count;
            workers.butterWorkers = Array.from({ length: count }, () => ({ busy: false, timeLeft: 0 }));
            break;
        case 'vegetable':
            config.vegetableWorkers = count;
            workers.vegetableWorkers = Array.from({ length: count }, () => ({ busy: false, timeLeft: 0 }));
            break;
        case 'pack':
            config.packWorkers = count;
            workers.packers = Array.from({ length: count }, () => ({ busy: false, timeLeft: 0 }));
            break;
    }
    
    initializeWorkerDisplays();
    updateUI();
}

function updateConfigInputs() {
    document.getElementById('totalBreads').value = config.totalBreads;
    document.getElementById('cutTime').value = config.cutTime;
    document.getElementById('butterTime').value = config.butterTime;
    document.getElementById('vegetableTime').value = config.vegetableTime;
    document.getElementById('packTime').value = config.packTime;
    document.getElementById('cutWorkers').value = config.cutWorkers;
    document.getElementById('butterWorkers').value = config.butterWorkers;
    document.getElementById('vegetableWorkers').value = config.vegetableWorkers;
    document.getElementById('packWorkers').value = config.packWorkers;
}

function toggleConfig() {
    showConfig = !showConfig;
    configPanel.classList.toggle('show', showConfig);
}

function toggleSimulation() {
    isRunning = !isRunning;
    
    if (isRunning) {
        playPauseBtn.className = 'btn btn-pause';
        playPauseIcon.textContent = '⏸';
        playPauseText.textContent = 'Tạm dừng';
        startSimulation();
    } else {
        playPauseBtn.className = 'btn btn-start';
        playPauseIcon.textContent = '▶';
        playPauseText.textContent = 'Bắt đầu';
        stopSimulation();
    }
}

function startSimulation() {
    lastUpdateTime = Date.now();
    
    // Determine update interval based on speed
    let updateInterval = 50; // Default 50ms
    if (speedMultiplier >= 200) {
        updateInterval = 10;
    } else if (speedMultiplier >= 100) {
        updateInterval = 20;
    } else if (speedMultiplier >= 50) {
        updateInterval = 30;
    }
    
    intervalId = setInterval(() => {
        if (!isRunning) return; // Safety check
        
        const now = Date.now();
        const deltaTime = now - lastUpdateTime;
        lastUpdateTime = now;
        
        // Accumulate time with speed multiplier
        accumulatedTime += (deltaTime / 1000) * speedMultiplier;
        
        // Process simulation steps
        let processedSteps = 0;
        const maxStepsPerFrame = speedMultiplier >= 100 ? 1000 : 200;
        
        while (accumulatedTime >= 1 && processedSteps < maxStepsPerFrame) {
            currentTime++;
            accumulatedTime -= 1;
            processedSteps++;
            
            // Update all workers
            updateWorkers();
            
            // Start new tasks
            startNewTasks();
            
            // Check and move workers when stages complete
            checkAndMoveWorkers();
            
            // Critical: Check completion after each step
            if (isSimulationComplete()) {
                finishSimulation();
                return;
            }
        }
        
        // Update UI based on speed
        if (speedMultiplier >= 200) {
            // Very fast - update every 10 steps
            if (currentTime % 10 === 0) {
                updateUI();
            }
        } else if (speedMultiplier >= 100) {
            // Fast - update every 5 steps
            if (currentTime % 5 === 0) {
                updateUI();
            }
        } else if (speedMultiplier >= 50) {
            // Medium fast - update every 2 steps
            if (currentTime % 2 === 0) {
                updateUI();
            }
        } else {
            // Normal speed - update every step
            updateUI();
        }
        
    }, updateInterval);
}

function isSimulationComplete() {
    return stats.completed >= config.totalBreads;
}

function finishSimulation() {
    // Stop the simulation
    stopSimulation();
    
    // Reset timing variables
    accumulatedTime = 0;
    
    // Update UI one final time
    updateUI();
    
    // Reset play button
    isRunning = false;
    playPauseBtn.className = 'btn btn-start';
    playPauseIcon.textContent = '▶';
    playPauseText.textContent = 'Bắt đầu';
    
    console.log('Simulation completed at time:', currentTime);
}

function stopSimulation() {
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
    }
}

function resetSimulation() {
    // Stop simulation
    stopSimulation();
    isRunning = false;
    
    // Reset timing
    currentTime = 0;
    lastUpdateTime = 0;
    accumulatedTime = 0;

    // Reset all stats
    stats = {
        completed: 0,
        cutting: { completed: 0, inProgress: 0 },
        buttering: { completed: 0, inProgress: 0 },
        vegetables: { completed: 0, inProgress: 0 },
        packing: { completed: 0, inProgress: 0 }
    };

    // Reset all queues
    queues = {
        afterCut: [],
        afterButter: [],
        afterVegetables: []
    };

    // Reset workers
    workers = {
        cutters: Array.from({ length: config.cutWorkers }, () => ({ busy: false, timeLeft: 0 })),
        butterWorkers: Array.from({ length: config.butterWorkers }, () => ({ busy: false, timeLeft: 0 })),
        vegetableWorkers: Array.from({ length: config.vegetableWorkers }, () => ({ busy: false, timeLeft: 0 })),
        packers: Array.from({ length: config.packWorkers }, () => ({ busy: false, timeLeft: 0 }))
    };

    // Reset button state
    playPauseBtn.className = 'btn btn-start';
    playPauseIcon.textContent = '▶';
    playPauseText.textContent = 'Bắt đầu';

    // Reinitialize displays
    initializeWorkerDisplays();
    updateConfigInputs();
    updateUI();
}

function updateWorkers() {
    // Update all worker types
    ['cutters', 'butterWorkers', 'vegetableWorkers', 'packers'].forEach(workerType => {
        workers[workerType].forEach((worker, index) => {
            if (worker.busy) {
                worker.timeLeft--;
                if (worker.timeLeft <= 0) {
                    worker.busy = false;
                    completeTask(workerType, index);
                }
            }
        });
    });
}

function checkAndMoveWorkers() {
    // Move cutters when cutting is complete
    if (stats.cutting.completed >= config.totalBreads) {
        const availableCutters = workers.cutters.filter(w => !w.busy);
        if (availableCutters.length > 0) {
            const halfToButtering = Math.floor(availableCutters.length / 2);
            const halfToVegetables = availableCutters.length - halfToButtering;

            // Move to buttering
            for (let i = 0; i < halfToButtering; i++) {
                workers.butterWorkers.push({ busy: false, timeLeft: 0 });
                config.butterWorkers++;
            }
            
            // Move to vegetables
            for (let i = 0; i < halfToVegetables; i++) {
                workers.vegetableWorkers.push({ busy: false, timeLeft: 0 });
                config.vegetableWorkers++;
            }

            // Remove moved workers
            workers.cutters = workers.cutters.filter(w => w.busy);
            config.cutWorkers = workers.cutters.length;
        }
    }

    // Move butter workers when buttering is complete
    if (stats.buttering.completed >= config.totalBreads) {
        const availableButterWorkers = workers.butterWorkers.filter(w => !w.busy);
        if (availableButterWorkers.length > 0) {
            // Move all to vegetables
            for (let i = 0; i < availableButterWorkers.length; i++) {
                workers.vegetableWorkers.push({ busy: false, timeLeft: 0 });
                config.vegetableWorkers++;
            }

            workers.butterWorkers = workers.butterWorkers.filter(w => w.busy);
            config.butterWorkers = workers.butterWorkers.length;
        }
    }

    // Move vegetable workers when vegetables are complete
    if (stats.vegetables.completed >= config.totalBreads) {
        const availableVegWorkers = workers.vegetableWorkers.filter(w => !w.busy);
        if (availableVegWorkers.length > 0) {
            // Move all to packing
            for (let i = 0; i < availableVegWorkers.length; i++) {
                workers.packers.push({ busy: false, timeLeft: 0 });
                config.packWorkers++;
            }

            workers.vegetableWorkers = workers.vegetableWorkers.filter(w => w.busy);
            config.vegetableWorkers = workers.vegetableWorkers.length;
        }
    }
}

function completeTask(workerType, workerIndex) {
    switch (workerType) {
        case 'cutters':
            stats.cutting.completed++;
            stats.cutting.inProgress = Math.max(0, stats.cutting.inProgress - 1);
            queues.afterCut.push({ id: Date.now() + Math.random() });
            break;
        case 'butterWorkers':
            stats.buttering.completed++;
            stats.buttering.inProgress = Math.max(0, stats.buttering.inProgress - 1);
            queues.afterButter.push({ id: Date.now() + Math.random() });
            break;
        case 'vegetableWorkers':
            stats.vegetables.completed++;
            stats.vegetables.inProgress = Math.max(0, stats.vegetables.inProgress - 1);
            queues.afterVegetables.push({ id: Date.now() + Math.random() });
            break;
        case 'packers':
            stats.packing.completed++;
            stats.packing.inProgress = Math.max(0, stats.packing.inProgress - 1);
            stats.completed++;
            break;
    }
}

function startNewTasks() {
    // Start cutting tasks
    if (stats.cutting.completed + stats.cutting.inProgress < config.totalBreads) {
        workers.cutters.forEach(worker => {
            if (!worker.busy && stats.cutting.completed + stats.cutting.inProgress < config.totalBreads) {
                worker.busy = true;
                worker.timeLeft = config.cutTime;
                stats.cutting.inProgress++;
            }
        });
    }
    
    // Start buttering tasks
    if (queues.afterCut.length > 0) {
        workers.butterWorkers.forEach(worker => {
            if (!worker.busy && queues.afterCut.length > 0) {
                worker.busy = true;
                worker.timeLeft = config.butterTime;
                queues.afterCut.shift();
                stats.buttering.inProgress++;
            }
        });
    }

    // Start vegetable tasks
    if (queues.afterButter.length > 0) {
        workers.vegetableWorkers.forEach(worker => {
            if (!worker.busy && queues.afterButter.length > 0) {
                worker.busy = true;
                worker.timeLeft = config.vegetableTime;
                queues.afterButter.shift();
                stats.vegetables.inProgress++;
            }
        });
    }

    // Start packing tasks
    if (queues.afterVegetables.length > 0) {
        workers.packers.forEach(worker => {
            if (!worker.busy && queues.afterVegetables.length > 0) {
                worker.busy = true;
                worker.timeLeft = config.packTime;
                queues.afterVegetables.shift();
                stats.packing.inProgress++;
            }
        });
    }
}

function calculateETA() {
    if (stats.completed >= config.totalBreads) return '00:00:00';
    
    const remainingItems = config.totalBreads - stats.completed;
    const completedItems = stats.completed;
    
    if (completedItems === 0 || currentTime === 0) {
        // Calculate based on configuration
        const cutRate = config.cutWorkers / config.cutTime;
        const butterRate = config.butterWorkers / config.butterTime;
        const vegetableRate = config.vegetableWorkers / config.vegetableTime;
        const packRate = config.packWorkers / config.packTime;
        const bottleneckRate = Math.min(cutRate, butterRate, vegetableRate, packRate);
        
        if (bottleneckRate > 0) {
            const estimatedTime = Math.ceil(remainingItems / bottleneckRate);
            return formatTime(estimatedTime);
        }
        return '∞';
    } else {
        // Calculate based on actual rate
        const actualTime = currentTime + (accumulatedTime > 0 ? accumulatedTime : 0);
        const currentRate = completedItems / actualTime;
        
        if (currentRate > 0) {
            const estimatedTime = Math.ceil(remainingItems / currentRate);
            return formatTime(estimatedTime);
        }
        return '∞';
    }
}

function formatTime(seconds) {
    if (!isFinite(seconds) || seconds < 0) return '∞';
    
    seconds = Math.round(seconds);
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function initializeWorkerDisplays() {
    // Cutter workers
    const cutterContainer = document.getElementById('cutterWorkers');
    if (cutterContainer) {
        cutterContainer.innerHTML = '';
        workers.cutters.forEach((worker, index) => {
            const workerDiv = document.createElement('div');
            workerDiv.className = 'worker-status worker-free';
            workerDiv.id = `cutter-${index}`;
            workerDiv.textContent = 'Rảnh';
            cutterContainer.appendChild(workerDiv);
        });
    }

    // Packer workers
    const packerContainer = document.getElementById('packerWorkers');
    if (packerContainer) {
        packerContainer.innerHTML = '';
        workers.packers.forEach((worker, index) => {
            const workerDiv = document.createElement('div');
            workerDiv.className = 'worker-status worker-free';
            workerDiv.id = `packer-${index}`;
            workerDiv.textContent = 'Rảnh';
            packerContainer.appendChild(workerDiv);
        });
    }

    // Parallel lines (butter & vegetable)
    const parallelContainer = document.getElementById('parallelLines');
    if (parallelContainer) {
        parallelContainer.innerHTML = '';
        const maxLines = Math.max(workers.butterWorkers.length, workers.vegetableWorkers.length, 4);
        for (let i = 0; i < maxLines; i++) {
            const butterStatus = workers.butterWorkers[i]
                ? `<div class="station-status worker-free" id="butter-${i}">Rảnh</div>`
                : `<div class="station-status" style="background:#f3f4f6;color:#bbb;">Không có người</div>`;
            const vegStatus = workers.vegetableWorkers[i]
                ? `<div class="station-status worker-free" id="vegetable-${i}">Rảnh</div>`
                : `<div class="station-status" style="background:#f3f4f6;color:#bbb;">Không có người</div>`;
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-container';
            lineDiv.innerHTML = `
                <div class="line-title">Dây chuyền ${i + 1}</div>
                <div class="line-station border-yellow-500">
                    <div class="station-name">Quét bơ</div>
                    ${butterStatus}
                </div>
                <div style="text-align: center; font-size: 0.875rem; margin: 0.5rem 0;">↓</div>
                <div class="line-station border-green-500">
                    <div class="station-name">Bỏ rau</div>
                    ${vegStatus}
                </div>
            `;
            parallelContainer.appendChild(lineDiv);
        }
    }
}

function updateUI() {
    // Update time
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        const actualTime = currentTime + (accumulatedTime > 0 ? accumulatedTime : 0);
        timeElement.textContent = formatTime(Math.floor(actualTime));
    }

    // Update ETA
    const etaElement = document.getElementById('etaTime');
    if (etaElement) etaElement.textContent = calculateETA();

    // Update config displays
    const cutTimeDisplay = document.getElementById('cutTimeDisplay');
    if (cutTimeDisplay) cutTimeDisplay.textContent = config.cutTime;
    
    const packTimeDisplay = document.getElementById('packTimeDisplay');
    if (packTimeDisplay) packTimeDisplay.textContent = config.packTime;
    
    const totalCount = document.getElementById('totalCount');
    if (totalCount) totalCount.textContent = config.totalBreads;

    // Update progress
    const completionPercentage = (stats.completed / config.totalBreads * 100);
    const completedCount = document.getElementById('completedCount');
    if (completedCount) completedCount.textContent = stats.completed;
    
    const completionPercentageElement = document.getElementById('completionPercentage');
    if (completionPercentageElement) {
        completionPercentageElement.textContent = completionPercentage.toFixed(1) + '%';
    }
    
    const progressFill = document.getElementById('progressFill');
    if (progressFill) progressFill.style.width = completionPercentage + '%';

    // Update stats
    const cutCompleted = document.getElementById('cutCompleted');
    if (cutCompleted) cutCompleted.textContent = stats.cutting.completed;
    
    const butterCompleted = document.getElementById('butterCompleted');
    if (butterCompleted) butterCompleted.textContent = stats.buttering.completed;
    
    const vegetableCompleted = document.getElementById('vegetableCompleted');
    if (vegetableCompleted) vegetableCompleted.textContent = stats.vegetables.completed;
    
    const packCompleted = document.getElementById('packCompleted');
    if (packCompleted) packCompleted.textContent = stats.packing.completed;
    
    const finalCompleted = document.getElementById('finalCompleted');
    if (finalCompleted) finalCompleted.textContent = stats.completed;

    // Update queues
    const afterCutQueue = document.getElementById('afterCutQueue');
    if (afterCutQueue) afterCutQueue.textContent = queues.afterCut.length;
    
    const afterVegetableQueue = document.getElementById('afterVegetableQueue');
    if (afterVegetableQueue) afterVegetableQueue.textContent = queues.afterVegetables.length;

    // Update worker status (less frequently for high speeds)
    if (speedMultiplier < 50) {
        updateWorkerStatus('cutter', workers.cutters);
        updateWorkerStatus('packer', workers.packers);
        updateWorkerStatus('butter', workers.butterWorkers);
        updateWorkerStatus('vegetable', workers.vegetableWorkers);
    }

    // Update statistics table
    updateStatisticsTable();
}

function updateWorkerStatus(prefix, workerArray) {
    workerArray.forEach((worker, index) => {
        const workerElement = document.getElementById(`${prefix}-${index}`);
        if (workerElement) {
            if (worker.busy) {
                workerElement.className = 'worker-status worker-busy';
                workerElement.textContent = `Bận (${worker.timeLeft}s)`;
            } else {
                workerElement.className = 'worker-status worker-free';
                workerElement.textContent = 'Rảnh';
            }
        }
    });
}

function updateStatisticsTable() {
    // Update basic stats
    const elements = [
        { id: 'cutTimeTable', value: config.cutTime },
        { id: 'butterTimeTable', value: config.butterTime },
        { id: 'vegetableTimeTable', value: config.vegetableTime },
        { id: 'packTimeTable', value: config.packTime },
        { id: 'cutCompletedTable', value: stats.cutting.completed },
        { id: 'butterCompletedTable', value: stats.buttering.completed },
        { id: 'vegetableCompletedTable', value: stats.vegetables.completed },
        { id: 'packCompletedTable', value: stats.packing.completed },
        { id: 'cutInProgressTable', value: stats.cutting.inProgress },
        { id: 'butterInProgressTable', value: stats.buttering.inProgress },
        { id: 'vegetableInProgressTable', value: stats.vegetables.inProgress },
        { id: 'packInProgressTable', value: stats.packing.inProgress },
        { id: 'cutWorkersCount', value: config.cutWorkers },
        { id: 'butterWorkersCount', value: config.butterWorkers },
        { id: 'vegetableWorkersCount', value: config.vegetableWorkers },
        { id: 'packWorkersCount', value: config.packWorkers }
    ];

    elements.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });

    // Update efficiency calculations
    const efficiencies = [
        { id: 'cutEfficiencyTable', workers: config.cutWorkers, time: config.cutTime },
        { id: 'butterEfficiencyTable', workers: config.butterWorkers, time: config.butterTime },
        { id: 'vegetableEfficiencyTable', workers: config.vegetableWorkers, time: config.vegetableTime },
        { id: 'packEfficiencyTable', workers: config.packWorkers, time: config.packTime }
    ];

    efficiencies.forEach(({ id, workers, time }) => {
        const element = document.getElementById(id);
        if (element) {
            const efficiency = workers > 0 ? (workers * 60 / time).toFixed(1) : '0';
            element.textContent = efficiency + ' bánh/phút';
        }
    });
}

// Initialize the application when the page loads
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
